---
title: "Untitled"
author: "Mike Frank"
date: "2022-12-15"
output: html_document
---

```{r}
source(here::here("helper/common.R"))
```

# Measure 1: Accuracies


## Window size

These simulations use ICCs as a way to understand how we summarize accuracy data. In particular, we're going to look at how ICCs change as a function of window size. 

```{r warning=FALSE, message=FALSE, error=FALSE, eval=FALSE}
icc_window_sim <- function (t_start = -500, t_end = 4000, object) 
{
  print(paste(t_start, t_end))
  
  df <- d_trial |>
    filter(t_norm > t_start, t_norm < t_end) |>
    group_by(dataset_name, dataset_id, administration_id, target_label, trial_id) |>
    summarise(accuracy = mean(correct, na.rm=TRUE),
              prop_data = mean(!is.na(correct)))
  
  # compute ICCs
  df |> 
    group_by(dataset_name) |> 
    nest() |>
    mutate(icc = unlist(map(data, ~get_icc(., "accuracy", object)))) |>
    select(-data) |>
    unnest(cols = c()) 
}

acc_params <- expand_grid(t_start = seq(-1000,1500,500),
                          t_end = seq(2000,4000,500),
                          object = c("stimulus", "administration")) |>
  mutate(icc = pmap(list(t_start, t_end, object), icc_window_sim)) |>
  unnest(col = icc)

save(file = "cached_intermediates/2_acc_params.Rds", acc_params)
```

```{r}
load(file = "cached_intermediates/2_acc_params.Rds")

ggplot(acc_params, aes(x = t_start, y = icc, col = as.factor(t_end))) + 
  geom_jitter() + 
  facet_wrap(~object) + 
  geom_smooth(aes(group = as.factor(t_end)), se = FALSE)
ggsave(here(figure_path,"reliability_window.png"),width=10,height=6,dpi=600)
```

Looks like for stimulus and administration you get consistent but modest gains if you take the longest window. BUT for stimuli, the early part of the trial adds reliability (probably because of bias due to stimulus-level preferences?). In contrast, for administrations, the early part of the trial is less informative. 500ms seems like a pretty good compromise. 

```{r}
ggplot(acc_params, aes(x = t_start, y = icc, col = as.factor(t_end))) + 
  geom_point() + 
  facet_wrap(~object) + 
  geom_smooth(aes(group = as.factor(t_end)), se = FALSE)

acc_params_summary <- acc_params %>%
  group_by(t_start,t_end,object) %>%
  summarize(
    N=n(),
    mean_icc=mean(icc,na.rm=TRUE)
  ) %>%
  mutate(
    window_size = t_end-t_start
  )

ggplot(filter(acc_params_summary,object=="administration"),aes(x=t_start,y=t_end,fill=mean_icc))+
  geom_tile(color="white")+
  scale_fill_viridis(name="Mean ICC\n(by-subject)",option="inferno")+
  theme_cowplot()+
  scale_x_continuous(breaks=c(-1000,-500,0,500,1000,1500))+
  xlab("Window Start Time (in ms)")+
  ylab("Window End Time (in ms)")
ggsave(here(figure_path,"reliability_window_grid_ICC_subject.png"),width=10,height=6,dpi=600)

ggplot(acc_params_summary,aes(x=t_start,y=t_end,fill=mean_icc))+
  geom_tile(color="white")+
  scale_fill_viridis(name="Mean ICC",option="inferno")+
  theme_cowplot()+
  scale_x_continuous(breaks=c(-1000,-500,0,500,1000,1500))+
  xlab("Window Start Time (in ms)")+
  ylab("Window End Time (in ms)")+
  facet_wrap(~object)
ggsave(here(figure_path,"reliability_window_grid_overall.png"),width=10,height=6,dpi=600)


ggplot(filter(acc_params_summary,object=="administration"),aes(color=mean_icc))+
  geom_vline(xintercept=0,linetype="dashed",size=1.2)+
  annotate("text", x = -600, y = 0.5, label = "Target Onset", size=7) +
  geom_segment(aes(x=t_start,xend=t_end,y=mean_icc,yend=mean_icc),size=2)+
  geom_segment(aes(x=t_start,xend=t_start,y=mean_icc-0.005,yend=mean_icc+0.005),size=2)+
  geom_segment(aes(x=t_end,xend=t_end,y=mean_icc-0.005,yend=mean_icc+0.005),size=2)+
  scale_color_viridis(name="Mean ICC",direction=-1)+
  scale_y_continuous(breaks=seq(0.2,0.5,0.1),limits=c(0.2,0.5))+
  theme_cowplot(font_size=20)+
  theme(legend.position="none")+
  ylab("Mean ICC")+
  xlab("Analysis Window (in ms)")
ggsave(here(figure_path,"reliability_window_segment_innovation.png"),width=10,height=6,dpi=600)

acc_params_summary <- acc_params_summary %>%
  mutate(
    highlight_start_1=if_else(t_start==-1000,1,0.5),
    highlight_start_2=if_else(t_start==-500,1,0.5),
    highlight_start_3=if_else(t_start==0,1,0.5),
    highlight_start_4=if_else(t_start==500,1,0.5),
    highlight_start_5=if_else(t_start==1000,1,0.5),
    )

ggplot(filter(acc_params_summary,object=="administration"),aes(color=mean_icc,alpha=highlight_start_1))+
  geom_vline(xintercept=0,linetype="dashed",size=1.2)+
  annotate("text", x = -600, y = 0.5, label = "Target Onset", size=7) +
  geom_segment(aes(x=t_start,xend=t_end,y=mean_icc,yend=mean_icc),size=2)+
  geom_segment(aes(x=t_start,xend=t_start,y=mean_icc-0.005,yend=mean_icc+0.005),size=2)+
  geom_segment(aes(x=t_end,xend=t_end,y=mean_icc-0.005,yend=mean_icc+0.005),size=2)+
  scale_color_viridis(name="Mean ICC",direction=-1)+
  scale_y_continuous(breaks=seq(0.2,0.5,0.1),limits=c(0.2,0.5))+
  scale_alpha_continuous(range=c(0.2,1))+
  theme_cowplot(font_size=20)+
  theme(legend.position="none")+
  ylab("Mean ICC")+
  xlab("Analysis Window (in ms)")
ggsave(here(figure_path,"reliability_window_segment_innovation_1.png"),width=10,height=6,dpi=600)

ggplot(filter(acc_params_summary,object=="administration"),aes(color=mean_icc,alpha=highlight_start_3))+
  geom_vline(xintercept=0,linetype="dashed",size=1.2)+
  annotate("text", x = -600, y = 0.5, label = "Target Onset", size=7) +
  geom_segment(aes(x=t_start,xend=t_end,y=mean_icc,yend=mean_icc),size=2)+
  geom_segment(aes(x=t_start,xend=t_start,y=mean_icc-0.005,yend=mean_icc+0.005),size=2)+
  geom_segment(aes(x=t_end,xend=t_end,y=mean_icc-0.005,yend=mean_icc+0.005),size=2)+
  scale_color_viridis(name="Mean ICC",direction=-1)+
  scale_y_continuous(breaks=seq(0.2,0.5,0.1),limits=c(0.2,0.5))+
  scale_alpha_continuous(range=c(0.2,1))+
  theme_cowplot(font_size=20)+
  theme(legend.position="none")+
  ylab("Mean ICC")+
  xlab("Analysis Window (in ms)")
ggsave(here(figure_path,"reliability_window_segment_innovation_2.png"),width=10,height=6,dpi=600)


ggplot(filter(acc_params_summary,object=="administration"),aes(color=mean_icc,alpha=highlight_start_4))+
  geom_vline(xintercept=0,linetype="dashed",size=1.2)+
  annotate("text", x = -600, y = 0.5, label = "Target Onset", size=7) +
  geom_segment(aes(x=t_start,xend=t_end,y=mean_icc,yend=mean_icc),size=2)+
  geom_segment(aes(x=t_start,xend=t_start,y=mean_icc-0.005,yend=mean_icc+0.005),size=2)+
  geom_segment(aes(x=t_end,xend=t_end,y=mean_icc-0.005,yend=mean_icc+0.005),size=2)+
  scale_color_viridis(name="Mean ICC",direction=-1)+
  scale_y_continuous(breaks=seq(0.2,0.5,0.1),limits=c(0.2,0.5))+
  scale_alpha_continuous(range=c(0.2,1))+
  theme_cowplot(font_size=20)+
  theme(legend.position="none")+
  ylab("Mean ICC")+
  xlab("Analysis Window (in ms)")
ggsave(here(figure_path,"reliability_window_segment_innovation_3.png"),width=10,height=6,dpi=600)


```


## Window size by age

Let's do one more simulation where we check if this result holds across two ages. We'll break down age into > 24 months and < 24 months, which roughly splits the dataset. There are `r  length(unique(d_trial$administration_id[d_trial$age < 24]))` younger kids and `r length(unique(d_trial$administration_id[d_trial$age >= 24]))` older kids. 


```{r warning=FALSE, message=FALSE, error=FALSE, eval=TRUE}
icc_window_sim <- function (t_start = 0, t_end = 4000, object) 
{
  df <- d_trial |>
    mutate(younger = age < 24) |>
    filter(t_norm > t_start, t_norm < t_end) |>
    group_by(dataset_name, dataset_id, younger, administration_id, 
             target_label, trial_id) |>
    summarise(accuracy = mean(correct, na.rm=TRUE),
              prop_data = mean(!is.na(correct)))
  
  # compute ICCs
  df |> 
    group_by(dataset_name, younger) |> 
    nest() |>
    mutate(icc = unlist(map(data, ~get_icc(., "accuracy", object)))) |>
    select(-data) |>
    unnest(cols = c()) 
}

acc_params_byage <- expand_grid(t_start = seq(0,1500,500),
                                t_end = seq(2000,4000,500),
                                object = c("stimulus", "administration")) |>
  mutate(icc = pmap(list(t_start, t_end, object), icc_window_sim)) |>
  unnest(col = icc)

save(file = "cached_intermediates/2_acc_params_byage.Rds", acc_params_byage)
```

Now plot. 

```{r}
load(file = "cached_intermediates/2_acc_params_byage.Rds")

ggplot(acc_params_byage, aes(x = t_start, y = icc, col = as.factor(t_end))) + 
  geom_jitter() + 
  facet_grid(younger~object) + 
  geom_smooth(aes(group = as.factor(t_end)), se = FALSE)
```

Here we see that the younger kids lose more reliability when the window is short, but otherwise the conclusions remain unchanged. 

```{r}
acc_params_byage_summary <- acc_params_byage %>%
  group_by(younger,t_start,t_end,object) %>%
  summarize(
    N=n(),
    mean_icc=mean(icc,na.rm=TRUE)
  ) %>%
  mutate(
    window_size = t_end-t_start
  ) %>%
  mutate(
    age=ifelse(younger,">=24 months","<24 months")
  )

ggplot(filter(acc_params_byage_summary,object=="administration"),aes(x=t_start,y=t_end,fill=mean_icc))+
  geom_tile(color="white")+
  scale_fill_viridis(name="Mean ICC\n(by-subject)",option="inferno")+
  theme_cowplot()+
  scale_x_continuous(breaks=c(-1000,-500,0,500,1000,1500))+
  xlab("Window Start Time (in ms)")+
  ylab("Window End Time (in ms)")+
  facet_wrap(~age)
ggsave(here(figure_path,"reliability_window_grid_ICC_subject_byage.png"),width=10,height=6,dpi=600)
```


# Summary

We learned:

* use ALL THE DATA (tm) when calculating accuracies
* don't exclude zoner trials because you think they have no signal - they add signal
* baseline correction doesn't help increase reliability, though correcting for baseline effects decreases stimulus-level reliability - presumably because some stimulus-level reliability is driven by visual salience (e.g., animacy) not by true differences in word difficulty. 
* RT is surprisingly reliable as a measure of participant variation (often better than accuracy) but not as good as accuracy for characterizing stimulus variation (perhaps due to the visual salience issue). 
* log RT is not much better or much worse than regular RT. 
